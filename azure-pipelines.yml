trigger:
  - master

variables:
  - group: AzureCredentials
  - name: ContainerDbPort
    readonly: true
    value: 1433
  - name: ContainerDbConnectionString
    readonly: true
    value: 'Server=localhost,$(ContainerDbPort);Database=LearningTerraform;User Id=sa;password=$(DockerDbContainerPassword)'

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: BuildAndTest
  displayName: Build & run pre-deployment tests
  jobs:
  - job: BuildAndTest
    displayName: Build & Test
    steps:
    - task: DotNetCoreCLI@2
      displayName: Run dotnet restore
      inputs:
        command: restore
        projects: '$(System.DefaultWorkingDirectory)/App'
        includeNuGetOrg: true
    - task: DotNetCoreCLI@2
      displayName: Run dotnet build
      inputs:
        command: build
        arguments: '--configuration Debug --no-restore'
        projects: '$(System.DefaultWorkingDirectory)/App'
    - task: DotNetCoreCLI@2
      displayName: Run unit tests
      inputs:
        command: test
        arguments: '--no-build'
        projects: '$(System.DefaultWorkingDirectory)/App/Tests/LearningTerraform.BusinessLogic.UnitTests'
    - script: |
        docker run -d --rm --name MSSQL -e 'ACCEPT_EULA=Y' -e 'SA_PASSWORD=$(DockerDbContainerPassword)' -e 'MSSQL_PID=Developer' -p $(ContainerDbPort):1433 mcr.microsoft.com/mssql/server:2017-latest
      displayName: Create DB Container
      name: CreateDbContainer
    - script: |
        wget https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh
        dotnet tool install --global --version 3.1.9 dotnet-ef
        chmod +rx wait-for-it.sh
        ./wait-for-it.sh -h localhost -p $(ContainerDbPort) -t 180
      displayName: Install tools
      name: InstallTools
    - script: |
        export PATH=$PATH:$HOME/.dotnet/tools
        . ~/.bashrc
        dotnet ef database update -s ../LearningTerraform.Api
      displayName: Migrate Database in Container
      name: MigrateContainerDatabase
      workingDirectory: '$(System.DefaultWorkingDirectory)/App/Src/LearningTerraform.DataAccess.MsSql'
      env:
        ConnectionStrings__Default: $(ContainerDbConnectionString)
    - task: DotNetCoreCLI@2
      displayName: Run pre-deployment integration tests
      inputs:
        command: test
        arguments: '--no-build --filter "Category=PreDeployment"'
        projects: '$(System.DefaultWorkingDirectory)/App/Tests/LearningTerraform.Api.IntegrationTests'
      env:
        ConnectionStrings__Default: $(ContainerDbConnectionString)
    - script: |
        docker stop MSSQL
      displayName: Destroy DB Container
      name: DestroyDbContainer

- stage: ExecuteTerraform
  dependsOn: BuildAndTest
  condition: false
  jobs:
  - job: ApplyTerraform
    displayName: Apply Terraform
    steps:
    - script: terraform init
      workingDirectory: '$(System.DefaultWorkingDirectory)/Terraform'
      displayName: 'Terraform - Initialize'
      env:
        ARM_CLIENT_ID: '$(Azure.ClientId)'
        ARM_CLIENT_SECRET: '$(Azure.ClientSecret)'
        ARM_SUBSCRIPTION_ID: '$(Azure.SubscriptionId)'
        ARM_TENANT_ID: '$(Azure.TenantId)'

    - script: terraform apply -auto-approve
      workingDirectory: '$(System.DefaultWorkingDirectory)/Terraform'
      displayName: 'Terraform - Apply'
      env:
        ARM_CLIENT_ID: '$(Azure.ClientId)'
        ARM_CLIENT_SECRET: '$(Azure.ClientSecret)'
        ARM_SUBSCRIPTION_ID: '$(Azure.SubscriptionId)'
        ARM_TENANT_ID: '$(Azure.TenantId)'
