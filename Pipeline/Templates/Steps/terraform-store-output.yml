parameters:
  - name: workingDirectory
    type: string
    displayName: Working directory for Terraform
  - name: outputSource
    type: string
    displayName: Arguments for plan command
  - name: targetVariable
    type: string
    displayName: Name of the target variable
  - name: stepName
    type: string
    displayName: Name of the step to reference the variable
  - name: azureClientId
    type: string
    displayName: Client ID for Azure
  - name: azureClientSecret
    type: string
    displayName: Client secret for Azure
  - name: azureSubscriptionId
    type: string
    displayName: Subscription ID for Azure
  - name: azureTenantId
    type: string
    displayName: Tenant ID for Azure

steps:
  - script: |
      result=`terraform output -json ${{ parameters.outputSource }} | jq -r .`
      echo "##vso[task.setvariable variable=${{ parameters.targetVariable }};isOutput=true]$result"
    workingDirectory: ${{ parameters.workingDirectory }}
    displayName: Terraform - Store output ${{ parameters.outputSource }}
    name: ${{ parameters.stepName }}
    env:
      ARM_CLIENT_ID: ${{ parameters.azureClientId }}
      ARM_CLIENT_SECRET: ${{ parameters.azureClientSecret }}
      ARM_SUBSCRIPTION_ID: ${{ parameters.azureSubscriptionId }}
      ARM_TENANT_ID: ${{ parameters.azureTenantId }}
